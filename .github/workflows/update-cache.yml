name: Update Stock Cache

on:
  workflow_dispatch: # Allows manual runs from the Actions tab
  schedule:
    # Note: Times are in UTC. (CST is UTC-6). Runs are offset by 10 mins.
    - cron: '20,50 14 * * 1-5'      # 8:20, 8:50 AM CST
    - cron: '20,50 15-20 * * 1-5'  # Every 30 mins from 9:20 AM to 2:50 PM CST
    - cron: '10 21 * * 1-5'        # Final run at 3:10 PM CST

permissions:
  contents: read # Read-only access to checkout the repo
  pages: write    # Permission to write to GitHub Pages
  id-token: write # Permission for OIDC token

jobs:
  # This job fetches fresh data and builds the static site
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Refresh stock data cache
        run: python -m services.run_cache_update

      - name: Build static site
        run: python build_static.py

      - name: Copy static assets to site folder
        run: |
          cp html/*.png site/ || true
          cp html/css/*.css site/css/ -r || true
          cp html/js/*.js site/js/ -r || true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  # This job takes the built site and deploys it
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4