<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Watchlist Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 100%;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1d78c1;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #1d78c1;
            font-size: 20px;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            table-layout: fixed; /* Ensures all columns have a fixed width */
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            font-size: 16px;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;    /* Hide overflow */
            text-overflow: ellipsis; /* Adds ellipsis for truncated text */
        }
        th {
            background-color: #f5f7fa;
            color: #1d78c1;
        }
        /* Specific column widths */
        th.company-name, td.company-name {
            width: 12%;
        }
        th.symbol, td.symbol {
            width: 6%;
        }
        th.change, td.change,
        th.percent-change, td.percent-change,
        th.rsi, td.rsi
        th.open, td.open,
        th.high, td.high,
        th.low, td.low,
        th.close, td.close,
        th.market-cap, td.market-cap {
            text-align: center;
        }
        .button-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .refresh-button {
            background-color: #1d78c1;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .refresh-button:hover {
            background-color: #155a8a;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid #1d78c1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-icon {
            display: inline-block;
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em; /* Smaller font size for the icon */
            padding: 0; /* No padding */
            border: none; /* Remove default button border */
            background: none; /* Remove any background */
            outline: none; /* Remove outline */
            width: auto; /* Allow width to adjust based on content */
            height: auto; /* Allow height to adjust based on content */
        }
        .popup {
            position: absolute;
            background-color: #f0f0f0; /* Gray background */
            border: 1px solid #e0e0e0; /* Optional border */
            padding: 10px;
            border-radius: 4px;
            z-index: 1000; /* Ensure popup is above other elements */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none; /* Initially hidden */
            max-width: 600px; /* Set a maximum width for the popup */
            max-height: 300px; /* Set a maximum height for the popup */
            font-size: 12px; /* Set a smaller font size */
            overflow: auto; /* Allow scrolling if content exceeds max height */
            word-wrap: break-word; /* Allow text to wrap within the popup */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get reference to the refresh button
            const refreshButton = document.getElementById('refresh-button');
            
            // Add click event listener to the refresh button
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    // Replace the existing onclick handler to prevent double execution
                    refreshButton.onclick = null;
                    
                    // Call refreshAllData directly
                    refreshAllData();
                    
                    // Return false to prevent any default action
                    return false;
                });
            }
            
            // Initial load - use cache
            fetchWatchlistData();

            const infoIcons = document.querySelectorAll('.info-icon');
            const popup = document.createElement('div');
            popup.className = 'popup';
            document.body.appendChild(popup); // Append popup to the body

            infoIcons.forEach(icon => {

                icon.addEventListener('click', function(event) {
                    // Log the click event
                    // Prevent the popup from closing immediately
                    event.stopPropagation();

                    // Set the popup content and position
                    popup.textContent = icon.getAttribute('title'); // Get the title for the popup
                    const rect = icon.getBoundingClientRect();
                    popup.style.left = `${rect.left + window.scrollX}px`;
                    popup.style.top = `${rect.top + window.scrollY - popup.offsetHeight - 5}px`; // Position above the icon
                    popup.style.display = 'block'; // Show popup
                });
            });

            // Hide popup when clicking outside
            document.addEventListener('click', function() {
                popup.style.display = 'none'; // Hide popup
            });
        });

        async function fetchWatchlistData() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.style.display = 'inline-block';

            // Clear only the existing stock data sections, not the entire container
            document.querySelectorAll('.section').forEach(section => section.remove());

            const categories = [
                'Owned',
                'Information Technology',
                'Industrials',
                'Energy & Utilities',
                'Financial Services',
                'Healthcare',
                'Communication Services',
                'Real Estate',
                'Consumer Staples',
                'Consumer Discretionary'
            ];


            try {
                for (let category of categories) {

                    const url = `/saved_stock_info?category=${encodeURIComponent(category)}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const data = await response.json();

                    // Render the category data
                    renderCategory(category, data);
                }
            } catch (error) {
                console.error('Error fetching watchlist data:', error);
            } finally {
                if (spinner) spinner.style.display = 'none';
            }
        }

        async function refreshAllData() {
            const button = document.getElementById('refresh-button');
            const spinner = document.getElementById('loading-spinner');
            
            if (button) button.disabled = true;
            if (spinner) spinner.style.display = 'inline-block';

            // Clear only the existing stock data sections, not the entire container
            document.querySelectorAll('.section').forEach(section => section.remove());

            const categories = [
                'Owned',
                'Information Technology',
                'Industrials',
                'Energy & Utilities',
                'Financial Services',
                'Healthcare',
                'Communication Services',
                'Real Estate',
                'Consumer Staples',
                'Consumer Discretionary'
            ];


            try {
                for (let i = 0; i < categories.length; i++) {
                    const category = categories[i];
                    const isFirst = i === 0;
                    const isLast = i === categories.length - 1;
                    
                    // Build URL with appropriate parameters
                    let url = `/saved_stock_info?category=${encodeURIComponent(category)}&refresh=true`;
                    
                    // Add first/last parameters as needed
                    if (isFirst) url += '&first=true';
                    if (isLast) url += '&last=true';
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const data = await response.json();

                    // Render the category data
                    renderCategory(category, data);
                }
            } catch (error) {
                console.error('Error refreshing watchlist data:', error);
            } finally {
                if (button) button.disabled = false;
                if (spinner) spinner.style.display = 'none';
            }
        }

        function renderCategory(category, data) {
            const section = document.createElement('div');
            section.className = 'section';

            const categoryHeading = document.createElement('h2');
            categoryHeading.textContent = category;
            section.appendChild(categoryHeading);

            // Check if the category is "Owned"
            if (category === 'Owned') {
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th class="company-name">Company Name</th>
                        <th class="symbol">Symbol</th>
                        <th class="market-cap">Market Cap</th>
                        <th class="rsi">RSI</th>
                        <th class="open">Open</th>
                        <th class="high">High</th>
                        <th class="low">Low</th>
                        <th class="close">Close</th>
                        <th class="change">Change</th>
                        <th class="percent-change">% Change</th>
                    </tr>
                `;

                const tbody = document.createElement('tbody');
                data.forEach(stock => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-symbol', stock.Symbol);
                    
                    const priceChangeColor = getColorForChange(stock['Percent Change']);
                    const percentChangeColor = getColorForChange(stock['Percent Change']);
                    const rsiColor = getRsiBackgroundStyle(stock.RSI);
                    const trailingPeColor = getTrailingPeColor(stock["Trailing PE"]);
                    const forwardPeColor = getForwardPeColor(stock["Forward PE"], stock["Trailing PE"]);

                    row.innerHTML = `
                        <td class="company-name truncate">
                            <button class="info-icon" 
                                    data-stock-name="${stock.Name}"
                                    data-fifty-two-week-high="${stock['fiftyTwoWeekHigh'] || 'N/A'}"
                                    data-current-price="${stock['Close'].toFixed(2) || 'N/A'}"
                                    data-fifty-two-week-low="${stock['fiftyTwoWeekLow'] || 'N/A'}"
                                    title="${stock.stock_description || 'No description available'}"
                                    data-trailing-pe="${stock['Trailing PE'] || 'N/A'}"
                                    data-forward-pe="${stock['Forward PE'] || 'N/A'}"
                                    data-ev-ebitda="${stock['EV/EBITDA'] || 'N/A'}"
                                    data-trailing-pe-color="${trailingPeColor}"
                                    data-forward-pe-color="${forwardPeColor}">
                                <img src="info.png" alt="Info" style="width: 20px; height: 20px; border: none;"/>
                            </button>
                            <span style="margin-left: 10pt;">${stock.Name}</span>
                        </td>
                        <td class="symbol" style="cursor: pointer; color: blue; text-decoration: underline;" data-symbol="${stock.Symbol}">${stock.Symbol}</td>
                        <td class="market-cap">${formatMarketCap(stock['Market Cap'])}</td>
                        <td class="rsi" style="background-color: ${rsiColor};">${stock.RSI !== undefined ? formatRsi(stock.RSI) : '-'}</td>
                        <td class="open">${stock.Open !== undefined ? formatValue(stock.Open) : '-'}</td>
                        <td class="high">${stock.High !== undefined ? formatValue(stock.High) : '-'}</td>
                        <td class="low">${stock.Low !== undefined ? formatValue(stock.Low) : '-'}</td>
                        <td class="close">${stock.Close !== undefined ? formatValue(stock.Close) : '-'}</td>
                        <td class="change" style="background-color: ${priceChangeColor};">${stock['Price Change'] !== undefined ? formatChange(stock['Price Change']) : '-'}</td>
                        <td class="percent-change" style="background-color: ${percentChangeColor};">${stock['Percent Change'] !== undefined ? formatPercentChange(stock['Percent Change']) : '-'}</td>
                    `;

                    // Add click event listener for the stock symbol
                    const symbolCell = row.querySelector('.symbol');
                    symbolCell.addEventListener('click', function(event) {
                        event.preventDefault(); // Prevent default navigation
                        const symbol = this.getAttribute('data-symbol');
                        showChartPopup(symbol); // Call function to show chart popup
                    });

                    // Add click event listener for the info icon
                    const infoIcon = row.querySelector('.info-icon');
                    infoIcon.addEventListener('click', function(event) {
                        event.stopPropagation(); // Prevent the event from bubbling up
                        showInfoPopup(this); // Pass the button to the function
                    });

                    tbody.appendChild(row);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                section.appendChild(table);
            } else {
                // Organize stocks by industry for other categories
                const industries = {};

                // Organize stocks by industry
                data.forEach(stock => {
                    const industry = stock.industry || 'Uncategorized'; // Default to 'Uncategorized' if no industry
                    if (!industries[industry]) {
                        industries[industry] = []; // Initialize array for industry
                    }
                    industries[industry].push(stock); // Add stock to the appropriate industry
                });

                // Create a table for each industry
                for (const [industry, stocks] of Object.entries(industries)) {
                    const industryHeading = document.createElement('h3');
                    industryHeading.textContent = industry;
                    section.appendChild(industryHeading);

                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th class="company-name">Company Name</th>
                            <th class="symbol">Symbol</th>
                            <th class="market-cap">Market Cap</th>
                            <th class="rsi">RSI</th>
                            <th class="open">Open</th>
                            <th class="high">High</th>
                            <th class="low">Low</th>
                            <th class="close">Close</th>
                            <th class="change">Change</th>
                            <th class="percent-change">% Change</th>
                        </tr>
                    `;

                    const tbody = document.createElement('tbody');
                    stocks.forEach(stock => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-symbol', stock.Symbol);
                        
                        const priceChangeColor = getColorForChange(stock['Percent Change']);
                        const percentChangeColor = getColorForChange(stock['Percent Change']);
                        const rsiColor = getRsiBackgroundStyle(stock.RSI);
                        const trailingPeColor = getTrailingPeColor(stock["Trailing PE"]);
                        const forwardPeColor = getForwardPeColor(stock["Forward PE"], stock["Trailing PE"]);

                        row.innerHTML = `
                            <td class="company-name truncate">
                                <button class="info-icon" 
                                        title="${stock.stock_description || 'No description available'}"
                                        data-fifty-two-week-high="${stock['fiftyTwoWeekHigh'] || 'N/A'}"
                                        data-current-price="${stock['Close'].toFixed(2) || 'N/A'}"
                                        data-fifty-two-week-low="${stock['fiftyTwoWeekLow'] || 'N/A'}"
                                        data-trailing-pe="${stock['Trailing PE'] || 'N/A'}"
                                        data-forward-pe="${stock['Forward PE'] || 'N/A'}"
                                        data-ev-ebitda="${stock['EV/EBITDA'] || 'N/A'}"
                                        data-trailing-pe-color="${trailingPeColor}"
                                        data-forward-pe-color="${forwardPeColor}">
                                    <img src="info.png" alt="Info" style="width: 20px; height: 20px; border: none;"/>
                                </button>
                                <span style="margin-left: 10pt;">${stock.Name}</span>
                            </td>
                            <td class="symbol" style="cursor: pointer; color: blue; text-decoration: underline;" data-symbol="${stock.Symbol}">${stock.Symbol}</td>
                            <td class="market-cap">${formatMarketCap(stock['Market Cap'])}</td>
                            <td class="rsi" style="background-color: ${rsiColor};">${stock.RSI !== undefined ? formatRsi(stock.RSI) : '-'}</td>
                            <td class="open">${stock.Open !== undefined ? formatValue(stock.Open) : '-'}</td>
                            <td class="high">${stock.High !== undefined ? formatValue(stock.High) : '-'}</td>
                            <td class="low">${stock.Low !== undefined ? formatValue(stock.Low) : '-'}</td>
                            <td class="close">${stock.Close !== undefined ? formatValue(stock.Close) : '-'}</td>
                            <td class="change" style="background-color: ${priceChangeColor};">${stock['Price Change'] !== undefined ? formatChange(stock['Price Change']) : '-'}</td>
                            <td class="percent-change" style="background-color: ${percentChangeColor};">${stock['Percent Change'] !== undefined ? formatPercentChange(stock['Percent Change']) : '-'}</td>
                        `;

                        // Add click event listener for the stock symbol
                        const symbolCell = row.querySelector('.symbol');
                        symbolCell.addEventListener('click', function(event) {
                            event.preventDefault(); // Prevent default navigation
                            const symbol = this.getAttribute('data-symbol');
                            showChartPopup(symbol); // Call function to show chart popup
                        });

                        // Add click event listener for the info icon
                        const infoIcon = row.querySelector('.info-icon');
                        infoIcon.addEventListener('click', function(event) {
                            event.stopPropagation(); // Prevent the event from bubbling up
                            showInfoPopup(this); // Pass the button to the function
                        });

                        tbody.appendChild(row);
                    });

                    table.appendChild(thead);
                    table.appendChild(tbody);
                    section.appendChild(table);
                }
            }

            document.querySelector('.container').appendChild(section);


        }

        // Utility functions
        function formatMarketCap(marketCap) {
        // Convert marketCap to a number to ensure it's numeric
        marketCap = Number(marketCap);
        
        // Check if marketCap is a valid number
        if (isNaN(marketCap)) {
            return 'N/A'; // Return 'N/A' if marketCap is not a number
        }

        // Market cap is assumed to be in millions
        if (marketCap >= 1_000_000) {
            // If the market cap is 1 trillion or more (1,000,000M), convert to trillions
            return (marketCap / 1_000_000).toFixed(2) + 'T';
        } else if (marketCap >= 1_000) {
            // If the market cap is 1 billion or more (1,000M), convert to billions
            return (marketCap / 1_000).toFixed(2) + 'B';
        } else if (marketCap > 0) {
            // Otherwise, display in millions
            return marketCap.toFixed(2) + 'M';
        } else {
            return 'N/A'; // Return 'N/A' for market cap of 0
        }
    }


        function formatValue(value) {
            return value !== null ? value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A';
        }

        function formatChange(value) {
            return value !== null ? value.toFixed(2) : 'N/A';
        }

        function formatPercentChange(value) {
            return value !== null ? `${value.toFixed(2)}%` : 'N/A';
        }

        function formatRsi(rsi) {
            return rsi !== null ? parseFloat(rsi).toFixed(2) : 'N/A';
        }

        function getColorForChange(percentChange) {
            if (percentChange <= -4) {
                return '#B30000';  // Dark Red
            } else if (percentChange <= -2) {
                return '#FF6347';  // Lighter Red
            } else if (percentChange < 0) {
                return '#FFA07A';  // Lightest Red
            } else if (percentChange === 0) {
                return '#808080';  // Grey
            } else if (percentChange <= 2) {
                return '#98FB98';  // Light Green
            } else if (percentChange <= 4) {
                return '#32CD32';  // Green
            } else {
                return '#008000';  // Dark Green
            }
        }

        function getTrailingPeColor(pe) {
            if (pe === null) {
                return '#FF6347';  // Lighter Red
            } else{
                return ''; 
            }
        }

        function getForwardPeColor(pe, trailingPe) {
            if (pe === null || pe < 0 || trailingPe === null) {
                return '#FF6347';  // Lighter Red
            } 
            else if (pe < trailingPe) {
                return '#32CD32';  // Lighter Green
            }
            else if (pe > trailingPe) {
                return '#FFA500';  // Yellow
            }
            else{
                return ''; 
            }
        }
        

        function getRsiBackgroundStyle(rsi) {
            const rsiValue = parseFloat(rsi);
            if (rsiValue < 30) {
                return '#FF6347';  // Light Red (RSI below 30)
            } else if (rsiValue < 35) {
                return '#FFA500';  // Orange (RSI below 35)
            } else if (rsiValue > 70) {
                return '#98FB98';  // Light Green (RSI above 70)
            } else if (rsiValue > 65) {
                return '#FFFF00';  // Yellow (RSI above 65)
            } else {
                return '';  // No background color for RSI between 35 and 65
            }
        }

        // Remove any existing onclick handler from the refresh button
        window.onload = function() {
            const refreshButton = document.getElementById('refresh-button');
            if (refreshButton) {
                // Remove the inline onclick attribute if it exists
                refreshButton.removeAttribute('onclick');
            }
        };

        // Function to show chart popup
        function showChartPopup(symbol) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'chart-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '1000';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            
            // Create popup container
            const popup = document.createElement('div');
            popup.className = 'chart-popup';
            popup.style.backgroundColor = 'white';
            popup.style.padding = '20px';
            popup.style.borderRadius = '5px';
            popup.style.width = '80%';
            popup.style.height = '80%';
            popup.style.maxWidth = '1200px';
            popup.style.maxHeight = '800px';
            popup.style.position = 'relative';
            
            // Create loading indicator
            const loading = document.createElement('div');
            loading.textContent = 'Loading chart...';
            loading.style.textAlign = 'center';
            loading.style.padding = '20px';
            
            popup.appendChild(loading);
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Create canvas for chart
            const canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.display = 'none'; // Hide until loaded
            
            popup.appendChild(canvas);
            
            // Load chart data
            fetch(`http://localhost:8000/get_chart_data?symbol=${symbol}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(chartData => {
                    if (!chartData || !chartData.labels) {
                        throw new Error('Invalid data received from server');
                    }
                    
                    // Hide loading indicator and show canvas
                    loading.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    // Function to format numbers to two decimal places
                    const formatNumber = num => num.toFixed(2);
                    
                    const formatDataForCandlestick = (data) => {
                        return data.labels.map((date, index) => ({
                            x: new Date(date).getTime(),
                            o: formatNumber(data.open[index]),
                            h: formatNumber(data.high[index]),
                            l: formatNumber(data.low[index]),
                            c: formatNumber(data.close[index])
                        }));
                    };
                    
                    const candlestickData = formatDataForCandlestick(chartData);
                    
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: chartData.companyName,
                                data: candlestickData,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Price'
                                    },
                                    ticks: {
                                        callback: (value) => {
                                            return value.toFixed(2); // Format y-axis labels
                                        }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                    loading.textContent = 'Failed to load chart data.';
                });
            
            // Close popup when clicking outside
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }

        function showInfoPopup(button) {
            // Get the stock details from the button's data attributes
            const stockName = button.getAttribute('data-stock-name');
            const description = button.getAttribute('title');
            const trailingPE = parseFloat(button.getAttribute('data-trailing-pe')).toFixed(2); // Format to 2 decimal points
            const forwardPE = parseFloat(button.getAttribute('data-forward-pe')).toFixed(2); // Format to 2 decimal points
            const evEbitda = parseFloat(button.getAttribute('data-ev-ebitda')).toFixed(2); // Format to 2 decimal points
            const currentPrice = parseFloat(button.getAttribute('data-current-price')); // Get current price
            const fiftyTwoWeekHigh = parseFloat(button.getAttribute('data-fifty-two-week-high')); // Get 52-week high
            const fiftyTwoWeekLow = parseFloat(button.getAttribute('data-fifty-two-week-low')); // Get 52-week low

            // Format current price to 2 decimal points
            const formattedCurrentPrice = currentPrice ? currentPrice.toFixed(2) : 'N/A';
            const formattedHigh = fiftyTwoWeekHigh ? fiftyTwoWeekHigh.toFixed(2) : 'N/A';
            const formattedLow = fiftyTwoWeekLow ? fiftyTwoWeekLow.toFixed(2) : 'N/A';

            // Determine font colors for PE values
            const trailingPeColor = getTrailingPeColor(parseFloat(trailingPE));
            const forwardPeColor = getForwardPeColor(parseFloat(forwardPE), parseFloat(trailingPE));

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'info-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '1000';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            
            // Create popup container
            const popup = document.createElement('div');
            popup.className = 'info-popup';
            popup.style.backgroundColor = 'white';
            popup.style.padding = '15px'; // Reduced padding
            popup.style.borderRadius = '5px';
            popup.style.width = '80%';
            popup.style.maxWidth = '600px';
            popup.style.position = 'relative';

            // Calculate the position of the current price on the line
            const position = ((currentPrice - fiftyTwoWeekLow) / (fiftyTwoWeekHigh - fiftyTwoWeekLow)) * 100;

            // Create content for the popup
            const content = `
                <h3>${stockName}</h3>
                <p style="font-size: 14px;">${description}</p>
                <p>
                    <span style="color: ${trailingPeColor};"><strong>Trailing PE:</strong> ${trailingPE}</span>
                    <span style="margin-left: 20px; color: ${forwardPeColor};"><strong>Forward PE:</strong> ${forwardPE}</span>
                    <span style="margin-left: 20px; color: ${trailingPeColor};"><strong>EV/EBITDA:</strong> ${evEbitda}</span>
                </p>
                <div style="display: flex; align-items: center; margin: 10px 0; font-size: 14px;"> <!-- Smaller font size -->
                    <div style="margin-right: 10px;"><strong>52 Week Low: $${formattedLow}</strong></div>
                    <div style="flex-grow: 1; position: relative;">
                        <hr style="border: 1px solid #ccc;"/>
                        <div style="position: absolute; left: ${position}%; transform: translate(-50%, -60%); color: blue; top: 50%;">
                            <strong style="font-size: 16px;">&#9670;</strong> <!-- Smaller diamond shape -->
                        </div>
                    </div>
                    <div style="margin-left: 10px;"><strong>52 Week High: $${formattedHigh}</strong></div>
                </div>
                <div style="text-align: center; margin-top: 5px; color: black;">
                    <strong style="font-size: 14px;"><strong>Current Price:</strong> $${formattedCurrentPrice}</strong>
                </div>
            `;
            popup.innerHTML = content; // Set the content of the popup
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Close popup when clicking outside
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Stock Watchlist Report</h1>
        <div class="button-container">
            <button id="refresh-button" class="refresh-button" onclick="fetchWatchlistData()">Refresh Data</button>
            <div id="loading-spinner" class="loading-spinner" style="display: none;"></div>
        </div>
    </div>
</body>
</html>